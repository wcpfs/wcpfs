#!/usr/bin/env bash

abspath="$(cd "${0%/*}" 2>/dev/null; echo "$PWD"/"${0##*/}")"
bin_dir=`dirname $abspath`
root_dir=`dirname $bin_dir`
app_name=`basename $root_dir`

if [[ $# -ne 1 ]]; then
  echo "Usage $0 <EC2 instance>"
  exit 1
fi

server=$1

echo "Deploying $app_name to $server"

# Server setup for running on Amazon EC2. Assumes Ubuntu 14.04.
ssh $server <<DOC
if ! git help > /dev/null; then
  sudo apt-get update
  sudo apt-get -y upgrade
  sudo apt-get -y install make g++ git daemontools build-essential
  echo "gem: --no-rdoc --no-ri" > ~/.gemrc
  sudo gem install bundler
fi
if [[ ! -d ~/git/$app_name ]]; then
  mkdir -p ~/git/$app_name.git
  cd ~/git/$app_name.git/
  git init --bare
  git --bare update-server-info
fi
DOC

# Add post receive hook
ssh $server "cat > ~/git/$app_name.git/hooks/post-receive" <<DOC
#!/bin/sh
mkdir -p ~/apps/$app_name
GIT_WORK_TREE=~/apps/$app_name git checkout -f
cd ~/apps/$app_name
bundle install --without test
/usr/bin/svc -t ~/apps/$app_name
DOC

# Start svscan
ssh $server <<DOC
chmod +x ~/git/$app_name.git/hooks/post-receive
if ! pgrep svscan; then
  /usr/bin/svscan ~/apps | logger -t supervise &
fi
DOC

git push $server:git/$app_name.git master
